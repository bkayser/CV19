---
title: "Cleaning COVID-19 Data from Johns Hopkins"
author: "Bill Kayser"
output:
  html_notebook: 
    fig_height: 6
    fig_width: 12
    toc: yes
  html_document: default
  pdf_document: 
    fig_height: 4
    fig_width: 7
    toc: yes
echo: TRUE

---

```{r results='hide', message=F, include=F}
library(tidyverse)
library(scales)
theme_set(theme_light())
source('utils.R')
knitr::opts_chunk$set(echo=F)
```


<style type="text/css">
.table {
    width: inherit;
    max-width: 100%;
    margin-bottom: 20px;
}
.math.display {
  font-size: 28px;
}
</style>

# Load Datasets

```{r echo=T}
cvdata.us <- readRDS('data/cvdata.us.RDS')
cvdata.us.by_state <- readRDS('data/cvdata.us.by_state.RDS')
cvdata.i18n <- readRDS('data/cvdata.i18n.RDS')
```

# Data Exploration

For the US Data I'm just showing a few states so the plots are more readable.  This is just preliminary exploration as I get to know the data and clean it for other purposes.

Let's first set up some parameters for the graph's X axis.

```{r}
start_date <- mdy('02/26/2020')
end_date <- max(cvdata.us$Date)
breaks <- seq(end_date,
              start_date,
              by="-1 week") %>% rev()
if (breaks[1] != start_date) {
  breaks <- c(breaks[1]-days(7), breaks)
  start_date <- breaks[1]
}
```

### Top Counties Infected

```{r}
cvdata.us %>%
  filter(!is.na(Division) & Date == end_date) %>%
  arrange(desc(Cases.Per100K)) %>%
  select(Key, Cases.Per100K, Deaths) %>%
  top_n(25) %>% knitr::kable()
```

### Reporting Anomalies

Consider the growth in deaths and cases, county by county, on each day of the week when there are at least 100 active confirmed cases.

```{r}
cvdata.daily <- cvdata.us %>%
  filter(Cases > 100) %>%
  mutate(day.of.week = factor(strftime(Date, '%A'), levels = c('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday')),
         Cases.Growth = Cases.Diff / Cases,
         Deaths.Growth = ifelse(Deaths == 0, 0, Deaths.Diff / Deaths))
```

What is the typical change in Confirmed Cases and Deaths on any day of the week?

```{r}
group_by(cvdata.daily, day.of.week) %>%
  summarize(Cases.Growth.Mean = percent(mean(Cases.Growth)),
            Deaths.Growth.Mean = percent(mean(Deaths.Growth, na.rm=T)))

ggplot(cvdata.daily) +
  aes(x=day.of.week, y = Cases.Growth) +
  geom_boxplot() +
  xlab('Day of Week') +
  ylab('Growth in Cases') +
  scale_y_continuous(labels=percent)
```


### Top Countries infected

```{r top_countries, fig.width=5}
max_date <- max(cvdata.i18n$Date)
countries <- 
  filter(cvdata.i18n, Date == max_date) %>%
  arrange(desc(Cases)) %>% 
  head(10)

ggplot(countries) +
  aes(fill=Country,
      x=Country,
      y=Cases) +
  geom_col(show.legend=F) +
  scale_y_continuous(labels=comma) +
  xlab(NULL)
```

### Confirmed Cases Grouped by State

```{r echo=F}
g <- cvdata.us.by_state %>%
  filter((State %in% c('New York', 'Oregon', 'Indiana', 'California'))) %>%
  mutate(State=factor(as.character(State))) %>%
  arrange(State, Date) %>%
  filter( Cases > 0) %>%
  ggplot() +
  aes(Date, Cases, color=State) +
  ggtitle('COVID-19 Confirmed Cases by States') +
  geom_line() + 
  xlab(NULL) +
  coord_cartesian(xlim=c(start_date, end_date)) +
  scale_x_date(breaks=breaks, date_labels = '%m/%d', date_minor_breaks='1 day')

g + scale_y_continuous(labels=comma) 
g + scale_y_log10(labels=comma) + labs(subtitle="Log Scale")
```

### Deaths, grouped by State.

```{r, echo=F}
g <- cvdata.us.by_state %>%
  filter((State %in% c('New York', 'Oregon', 'Indiana', 'California'))) %>%
  mutate(State=fct_drop(State)) %>%
  arrange(State, Date) %>%
  filter( Deaths > 0) %>%
  ggplot() +
  aes(Date, Deaths, color=State) + 
  geom_line() + 
  ggtitle('COVID-19 Deaths by State') +
  xlab(NULL) +
  coord_cartesian(xlim=c(start_date, end_date)) +
  scale_x_date(breaks=breaks, date_labels = '%m/%d', date_minor_breaks='1 day')

g + scale_y_continuous(labels=comma) 
g + scale_y_log10(labels=comma) + labs(subtitle = 'Log Scale') 

```

### Change in Confirmed Cases

This plot shows the day to day change in confirmed cases.  This is important because it will tell us when we hit that peak in infections, the top of the curve that we are trying to 'flatten'.  This peak occurs when the line crosses over the X axis into negative territory.

Right now you can see New York is a long way from that but the LOESS trend line shows it starting to trend downward.


```{r echo=F}
g <- cvdata.us %>%
  filter(State %in% c('New York', 'Oregon', 'Indiana', 'California')) %>%
  mutate(State = fct_drop(State)) %>%
  group_by(State, Date) %>%
  summarize(Cases.Diff3 = sum(Cases.Diff3)) %>%
  arrange(State, Date) %>%
  ggplot() +
  geom_line() + 
  geom_smooth(method='loess', span=0.2, size=0.5, linetype=3) +
  ggtitle('COVID-19 Confirmed Cases Day to Day Change, by States',
          subtitle = str_c("Reported data through ", format(max(cvdata.us$Date), "%B %d, %Y"))) +
  aes(Date, Cases.Diff3, color=State) +
  ylab("Daily Increase") +
  xlab(NULL)  +
  coord_cartesian(xlim=c(start_date, end_date)) +
  scale_x_date(breaks=breaks, date_labels = '%m/%d', date_minor_breaks='1 day')
g

```

```{r}
cvdata.us.by_state %>%
  filter(State %in% c('Arizona', 'Oregon', 'Indiana', 'California', 'New York')) %>%
  mutate(State = fct_drop(State)) %>%
  arrange(State, Date) %>%
  ggplot() +
  geom_line() + 
  #geom_smooth(method='loess', span=0.2, size=0.5, linetype=3) +
  ggtitle('COVID-19 Rate of Deaths Per Million, by States',
          subtitle = str_c("Reported data through ", format(max(cvdata.us$Date), "%B %d, %Y"))) +
  aes(Date, Death.Rate, color=State) +
  ylab("Daily Increase, per 1M people") +
  xlab(NULL)  +
  coord_cartesian(xlim=c(start_date, end_date)) +
  scale_x_date(breaks=breaks, date_labels = '%m/%d', date_minor_breaks='1 day')

```


### International Cases

```{r fig.width=6}
d0 <- filter(cvdata.i18n, Deaths >= 5 & Country %in% c("China, Hubei", "Spain", "France", "Germany","Iran", "Italy", "Korea, South", "United Kingdom", "US")) %>%
  mutate(Country = as.character(Country)) %>%
  filter(!is.na(Population))

d1 <- split(d0, d0$Country)
d2 <- lapply(d1, function(table) {
  table$Day <- 1:nrow(table)
  table
})

labels <- lapply(d2, tail, 1) %>% bind_rows()

country_data <- bind_rows(d2)

g <- ggplot(country_data) +
  aes(x=Day, color=Country) +
  geom_line(show.legend = F) +
  geom_text(data=labels, 
            mapping=aes(label=Country),
            show.legend = F,
            nudge_x = 0.5,
            check_overlap = F,
            size=3,
            hjust = 0) +
  coord_cartesian(xlim=c(0, max(labels$Day) + 15)) +
  ggtitle(paste0("National Trends as of ",format(end_date, "%B%e, %Y")), subtitle="Plotted individually from the first day of 5 recorded deaths") +
  xlab("Days Since First 24 Deaths") +
  facet_wrap('Country')

g + aes(y=Cases.Growth3) +
  ylab("Daily Increase in Cases") +
  scale_y_continuous(labels=percent) 

g + aes(y=Cases) + 
  ylab("Confirmed Cases")  +
  scale_y_continuous(labels=comma) 

g + aes(y=Deaths.Per100K) + 
  ylab("Deaths Per 100K Population") +
  scale_y_continuous(labels=comma) 

```


### State by State Confirmed Cases

```{r, fig.width=6, fig.height=6}
today <- filter(cvdata.us) %>%
  filter(Date == end_date & !is.na(Region) & Population > 500) %>%
  mutate(Cases.Rate = 1000000 * Cases / Population) 

averages.by_state <- tapply(today$Cases.Rate, today$State.Code, mean) %>% sort() %>% rev()
today <- mutate(today, State.Code = fct_relevel(State.Code, names(averages.by_state)))

ggplot(today) +
  aes(x = State.Code, y = Cases.Rate, fill = Region) +
  coord_flip(ylim=c(0,2000)) +
  geom_boxplot() +
ggtitle("")
```

### Infections Per Capita

Let's chart the current confirmed cases and deaths as a percentage of population.

```{r}
last_date <- max(cvdata.us.by_state$Date)

cvdata.us.by_state %>%
  filter(Date == last_date) %>%
  mutate(Infections.Per.100_000 = round(100000 * Cases / Population),
         Deaths.Per.100_000 = round(100000 * Deaths / Population, 1)) %>%
  select(State, Infections.Per.100_000, Deaths.Per.100_000) %>%
  arrange(desc(Infections.Per.100_000)) %>%
  head(10)

```

### Infection Rate by Region

```{r fig.width=5}
data <- cvdata.us.by_state %>% filter(Date == last_date)

ggplot(data) +
  aes(x=Division, y=Deaths.Per100K, fill=Division) +
  geom_boxplot() +
#  scale_y_log10(labels=comma) +
#  scale_x_discrete(labels=NULL) +
  xlab('Region') +
  ggtitle('Deaths Per 100K, by Region')
```


### Report on Lake Placid

Essex and Franklin counties seem to be closest.

```{r, fig.height=5}
our_counties <- filter(cvdata.us, 
                     (State == "New York" & County %in% c('Essex', 'Franklin', 'Clinton')) |
                     (State == "Indiana" & County %in% c('Hamilton')) |                       
                       (State == "California" & County %in% c('Contra Costa')) |
                     (State == "Arizona" & County %in% c('Maricopa')) |
                       (State == "Oregon" & County %in% c('Clackamas', 'Multnomah', 'Washington')))
labels <- filter(our_counties, Date == last_date)

g <- ggplot(our_counties) +
  aes(x=Date, y=Cases.Per100K, color=County) +
  xlab(NULL)  +
  coord_cartesian(xlim=c(mdy('03/15/2020'), end_date)) +
  ggtitle('Kayser Family Counties',
          subtitle = str_c("Reported data through ", format(max(cvdata.us$Date), "%B %d, %Y"))) +
  geom_line(aes(linetype=State)) + 
  geom_label(data=labels, aes(label=Key), hjust='right', show.legend=F, nudge_x = -1) +
  scale_x_date(breaks=breaks, date_labels = '%m/%d', date_minor_breaks='1 day')

g +
  aes(y = Cases.Per100K) +
  ylab("Confirmed Cases per 100K Population")

g +
  aes(y = Cases) +
  ylab("Confirmed Cases")
```




```{r}
all_counties <- cvdata.us %>%
  filter(!is.na(Division) & Date == end_date) %>%
  arrange(desc(Cases.Per100K)) %>%
  select(Key, Cases.Per100K) 

LP.Cases.Per100K <- filter(our_counties, Date == last_date) %>% 
  group_by(State) %>%
  summarize(Deaths = sum(Deaths),
            Cases = sum(Cases),
            Population = sum(Population)) %>%
  ungroup() %>%
  mutate(Cases.Per100K = Cases * 100000 / Population)

ranking <- round(sum(all_counties$Cases.Per100K <= LP.Cases.Per100K$Cases.Per100K[1]) / nrow(all_counties) * 100, 1)
median_rate <- median(all_counties$Cases.Per100K)
```

Total deaths to date in all three counties: `r LP.Cases.Per100K$Deaths`.

Total cases per 100K people: `r round(LP.Cases.Per100K$Cases.Per100K, 1)`

# Scatter Plots

Population Density vs. Infection Rate
```{r}
current_data <- filter(cvdata.us, Date == last_date & !is.na(Population.Density)) %>%
  mutate(Deaths.Per100K = Deaths * 100000 / Population)
ggplot(current_data) +
  aes(x=Cases.Diff3.Per100K) +
  geom_histogram(bins=400) +
  coord_cartesian(xlim=c(-10, 50))

ggplot(filter(current_data, Deaths.Per100K > 0)) +
  aes(x=Population.Density, y=Deaths.Per100K, show.legend=F) +
  geom_point(size=0.2) +
  geom_smooth(method='loess', color='red', size=0.5) +
  scale_y_log10(labels=comma) + 
  scale_x_log10() 
```


