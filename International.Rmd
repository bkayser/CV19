---
title: "Cleaning COVID-19 Data from Johns Hopkins"
author: "Bill Kayser"
output:
  html_notebook: 
    fig_height: 6
    fig_width: 12
    toc: yes
  html_document: default
  pdf_document: 
    fig_height: 4
    fig_width: 7
    toc: yes
echo: TRUE

---

```{r results='hide', message=F, include=F}
library(tidyverse)
library(scales)
library(caTools)
source('utils.R')
knitr::opts_chunk$set(echo=F)
theme_set(theme_fivethirtyeight())

library(ggthemes)

```


<style type="text/css">
.table {
    width: inherit;
    max-width: 100%;
    margin-bottom: 20px;
}
.math.display {
  font-size: 28px;
}
</style>

# Load Datasets

```{r echo=T}
cvdata.us <- readRDS('data/cvdata.us.RDS')
cvdata.us.by_state <- readRDS('data/cvdata.us.by_state.RDS')
cvdata.i18n <- readRDS('data/cvdata.i18n.RDS')
```

# Data Exploration

For the US Data I'm just showing a few states so the plots are more readable.  This is just preliminary exploration as I get to know the data and clean it for other purposes.

Let's first set up some parameters for the graph's X axis.

```{r}
start_date <- mdy('02/26/2020')
end_date <- max(cvdata.us$Date)
breaks <- seq(end_date,
              start_date,
              by="-1 week") %>% rev()
if (breaks[1] != start_date) {
  breaks <- c(breaks[1]-days(7), breaks)
  start_date <- breaks[1]
}
```

### Reporting Anomalies

Consider the growth in deaths and cases, county by county, on each day of the week when there are at least 100 active confirmed cases.

```{r}
cvdata.daily <- cvdata.us %>%
  filter(Cases > 100) %>%
  mutate(day.of.week = factor(strftime(Date, '%A'), levels = c('Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday')),
         Cases.Growth = Cases.Diff / Cases,
         Deaths.Growth = ifelse(Deaths == 0, 0, Deaths.Diff / Deaths))
```

What is the typical change in Confirmed Cases and Deaths on any day of the week?

```{r}
group_by(cvdata.daily, day.of.week) %>%
  summarize(Cases.Growth.Mean = percent(mean(Cases.Growth)),
            Deaths.Growth.Mean = percent(mean(Deaths.Growth, na.rm=T)))

ggplot(cvdata.daily) +
  aes(x=day.of.week, y = Cases.Growth) +
  geom_boxplot() +
  xlab('Day of Week') +
  ylab('Growth in Cases') +
  scale_y_continuous(labels=percent)
```


### Top Countries infected

```{r top_countries, fig.width=5}
max_date <- max(cvdata.i18n$Date)
countries <- 
  filter(cvdata.i18n, Date == max_date) %>%
  arrange(desc(Cases)) %>% 
  head(10)

ggplot(countries) +
  aes(fill=Country,
      x=Country,
      y=Cases) +
  geom_col(show.legend=F) +
  scale_y_continuous(labels=comma) +
  xlab(NULL)
```


```{r fig.width=5, fig.height=4}

top_countries <- cvdata.i18n %>%
  arrange(desc(Date)) %>%
  group_by(Key) %>%
  summarize(Cases.Per100K = first(Cases.Per100K)) %>%
  arrange(desc(Cases.Per100K)) %>%
  head(50)

ggplot(top_countries) +
  aes(x=reorder(Key, Cases.Per100K), y=Cases.Per100K, fill=Cases.Per100K) +
  geom_col() +
  scale_fill_gradient(low='#00FFAA', high='red', trans='log10') +
  geom_text(aes(label=round(Cases.Per100K)), size=4, nudge_y=30) +
  coord_flip() +  
  xlab(NULL) +
  ylab('Cases per 100K Population') +
  ggtitle('Countries Ranked by Per Capita Infection Rate') +
  theme(line = element_blank(), 
        panel.border = element_blank(),
        axis.text.x = element_blank(),
        legend.position=c(0.5,0.5))
  #scale_y_log10()

```

### International Cases

```{r fig.width=6}
d0 <- filter(cvdata.i18n, Deaths >= 5 & Country %in% c("China, Hubei", "Spain", "France", "Germany","Iran", "Italy", "Korea, South", "United Kingdom", "US")) %>%
  mutate(Country = as.character(Country)) %>%
  filter(!is.na(Population))

d1 <- split(d0, d0$Country)
d2 <- lapply(d1, function(table) {
  table$Day <- 1:nrow(table)
  table
})

labels <- lapply(d2, tail, 1) %>% bind_rows()

country_data <- bind_rows(d2)

#recovery_data <- country_data %>%
#  gather(key = 'Measure', value = 'Count', 'Cases', 'recovered.est', 'recovered')

g <- ggplot(country_data) +
  aes(x=Day) +
  geom_line(show.legend = F) +
  coord_cartesian(xlim=c(0, max(labels$Day) + 15)) +
  ggtitle(paste0("National Trends as of ",format(end_date, "%B%e, %Y")), subtitle="Plotted individually from the first day of 5 recorded deaths") +
  xlab("Days Since First 24 Deaths") +
  facet_wrap('Country')

g + aes(y=Cases.Growth3) +
  ylab("Daily Increase in Cases") +
  scale_y_continuous(labels=percent) 

g + aes(y=Cases) + 
  ylab("Confirmed Cases")  +
  scale_y_continuous(labels=comma) 

g + aes(y=Deaths.Per100K) + 
  ylab("Deaths Per 100K Population") +
  scale_y_continuous(labels=comma) 

```

